# CLAUDE.md - Project Guide for aiomtec2mqtt

## Project Overview

`aiomtec2mqtt` is a Python application that bridges M-TEC Energybutler (hybrid inverter/battery system) with MQTT brokers for home automation and energy management. It reads data via Modbus RTU protocol and publishes to MQTT, enabling integration with Home Assistant, evcc, and other EMS tools.

**Key Features:**

- Reads 80+ parameters from M-TEC Energybutler inverters
- Publishes to MQTT with configurable refresh rates
- Home Assistant auto-discovery support
- Minimal hardware requirements (runs on Raspberry Pi, NAS)
- Works locally without internet connection
- Optimized register scanning to reduce Modbus traffic

## Architecture

### Data Flow

```
M-TEC Energybutler (Modbus RTU) → aiomtec2mqtt → MQTT Broker → Home Assistant/evcc/EMS
                                                  ↓
                                          YAML Config File
```

### Key Components

1. **mtec_coordinator.py** - Main entry point, orchestrates data collection and publishing
2. **modbus_client.py** - Modbus RTU client for communicating with inverter
3. **mqtt_client.py** - MQTT client for publishing data
4. **hass_int.py** - Home Assistant integration and auto-discovery
5. **config.py** - Configuration management (reads from YAML)
6. **const.py** - Constants and register definitions

### Directory Structure

```
aiomtec2mqtt/
├── aiomtec2mqtt/        # Main package
│   ├── modbus_client.py # Modbus communication
│   ├── mqtt_client.py   # MQTT publishing
│   ├── hass_int.py      # Home Assistant integration
│   ├── config.py        # Configuration handling
│   ├── const.py         # Constants and registers
│   └── util/            # Utility tools
│       └── mtec_util.py # Interactive CLI for register reading/writing
├── tests/               # Test suite
├── templates/           # Home Assistant dashboards & evcc config
├── script/              # Development scripts
└── pyproject.toml       # Project configuration
```

## Development Setup

### Requirements

- Python 3.13+
- Dependencies: PyModbus 3.11.1, paho-mqtt, PyYAML, voluptuous

### Installation (Development Mode)

```bash
# Create virtual environment
python -m venv .
source bin/activate

# Install in editable mode with test dependencies
pip install -e .
pip install -r requirements_test.txt
```

### Running Tests

```bash
# Run all tests with coverage
pytest tests/ --cov=aiomtec2mqtt

# Run with coverage report
./cov.sh

# Type checking
mypy aiomtec2mqtt/

# Linting
ruff check aiomtec2mqtt/
pylint aiomtec2mqtt/
```

### Pre-commit Hooks

```bash
# Install pre-commit hooks
pre-commit install

# Run manually
pre-commit run --all-files
```

## Configuration

The application reads from `config.yaml` in the platform-specific config directory:

- Linux: `~/.config/aiomtec2mqtt/config.yaml`
- Windows: `C:\Users\<user>\AppData\Roaming\aiomtec2mqtt\config.yaml`

**Important Configuration Notes:**

- **MODBUS_PORT**: Changed from 5743 to 502 in firmware V27.52.4.0+
- **MODBUS_IP**: Usually `espressif.fritz.box` or the IP of the espressif device
- **REFRESH_NOW**: Default 10s for current data
- **HASS_ENABLE**: Set to `True` for Home Assistant auto-discovery

## Data Model

### MQTT Topics Structure

```
MTEC/<serial_number>/config       - Static config values (inverter settings)
MTEC/<serial_number>/now-base     - Current base data (power, SOC, status)
MTEC/<serial_number>/now-grid     - Current grid data (voltage, current, frequency)
MTEC/<serial_number>/now-inverter - Current inverter data (temperature, power per phase)
MTEC/<serial_number>/now-backup   - Current backup power data
MTEC/<serial_number>/now-battery  - Current battery data (temp, cell voltages)
MTEC/<serial_number>/now-pv       - Current PV data (voltage, current, power)
MTEC/<serial_number>/day          - Daily statistics (energy totals)
MTEC/<serial_number>/total        - Lifetime statistics
```

### Register Groups

Registers are organized in `const.py` by category:

- **Config registers** (10000-52505): Firmware, settings, limits
- **Now registers** (10100-33015): Real-time power, voltage, current, SOC
- **Day registers** (31000-31005): Daily energy totals
- **Total registers** (31102-31112): Lifetime energy totals

## Common Development Tasks

### Adding a New Register

1. Add register definition to `const.py` in the appropriate group
2. Define the register with address, name, unit, and data type
3. Update the MQTT topic mapping if needed
4. Add tests in `tests/`

### Testing with a Real Device

```bash
# Run the main application in debug mode
aiomtec2mqtt

# Use the utility to read/write registers interactively
aiomtec_util
```

### Updating Home Assistant Integration

- Dashboard templates are in `templates/`
- Auto-discovery config is generated by `hass_int.py`
- Background images go in `<hass_config>/www/`

## Testing Notes

### Coverage Requirements

- Target: High coverage for core modules
- Excluded from coverage: CLI utilities, interactive tools, config wizard
- See `pyproject.toml` [tool.coverage.run] for exclusions

### Test Structure

```
tests/
├── test_modbus_client.py  # Modbus communication tests
├── test_mqtt_client.py    # MQTT publishing tests
├── test_hass_int.py       # Home Assistant integration tests
└── ...
```

## Code Quality Tools

### Linting & Formatting

- **ruff**: Primary linter and formatter (fast, comprehensive)
- **pylint**: Additional static analysis
- **mypy**: Type checking (strict mode)

### Style Guidelines

- Line length: 99 characters
- Python 3.13+ type hints required
- Use `from __future__ import annotations`
- Follow PEP 484 for type annotations

## Deployment

### Systemd Service

```bash
# Install as system service
sudo bin/install_systemd_service.sh

# Check status
sudo systemctl status aiomtec2mqtt

# View logs
journalctl -u aiomtec2mqtt -f
```

## Compatibility

### Supported Devices

- M-TEC Energybutler GEN3 (8kW-3P-3G25 and similar models)
- Potentially compatible: Wattsonic, Sunways, Daxtromn (similar firmware)

### Firmware Versions

- **Before V27.52.4.0**: Use MODBUS_PORT 5743
- **V27.52.4.0+**: Use MODBUS_PORT 502

## Known Issues & Gotchas

1. **Port Change**: M-TEC changed Modbus port in firmware V27.52.4.0
2. **Espressif Device**: Must find the IP of the "espressif" device on your network
3. **Modbus Framer**: Usually "rtu", but external adapters may need different settings
4. **MQTT Birth Message**: Home Assistant waits 15s after birth message (configurable)

## Useful Commands

```bash
# List all known registers
aiomtec_util  # Choose option 1

# Read a specific register group
aiomtec_util  # Choose option 3

# Export data to CSV
aiomtec_export -g all -c -f output.csv

# Run tests with verbose output
pytest -v tests/

# Type check
mypy aiomtec2mqtt/

# Format and lint
ruff format aiomtec2mqtt/
ruff check --fix aiomtec2mqtt/
```

## Related Projects

- Original project: [croedel/MTECmqtt](https://github.com/croedel/MTECmqtt)
- Home Assistant: https://www.home-assistant.io
- evcc: https://evcc.io
- Mosquitto MQTT: https://mosquitto.org

## Getting Help

- Issues: https://github.com/sukramj/aiomtec2mqtt/issues
- Discussions: https://github.com/sukramj/aiomtec2mqtt/discussions
- Forum thread: https://www.photovoltaikforum.com/thread/206243-*

## License

LGPL - See LICENSE file for details
